env:
  IMAGE_VERSION: "py3.12-latest"

# Define reusable path patterns
common-paths: &common-paths
  - "pyproject.toml"
  - "docker/Dockerfile.python3.12"

sta-kernel-paths: &sta-kernel-paths
  - "csrc/attn/st_attn/**"
  - "csrc/attn/setup_sta.py"
  - "csrc/attn/config_sta.py"
  - "csrc/attn/st_attn.cpp"

vsa-kernel-paths: &vsa-kernel-paths
  - "csrc/attn/vsa/**"
  - "csrc/attn/tk/**"
  - "csrc/attn/setup_vsa.py"
  - "csrc/attn/config_vsa.py"
  - "csrc/attn/vsa.cpp"

steps:
  - block: "Start Build"
    blocked_state: "running"
    prompt: "Approve build?"

  - label: "Trigger Tests"
    command: |
      echo "Current working directory: $(pwd)"
      echo "Current branch:"
      git branch --show-current
      echo "Full diff:"
      git diff --name-only $BUILDKITE_PULL_REQUEST_BASE_BRANCH...HEAD
    plugins:
      - monorepo-diff#v1.4.0:
          diff: "git diff --name-only $BUILDKITE_PULL_REQUEST_BASE_BRANCH...HEAD"
          watch:
            - path: 
                - "fastvideo/v1/models/encoders/**"
                - "fastvideo/v1/models/loaders/**"
                - "fastvideo/v1/tests/encoders/**"
                - *common-paths
              config:
                command: "timeout 30m .buildkite/scripts/pr_test.sh"
                label: "Encoder Tests"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=encoder
                agents:
                  queue: "default"
            - path:
                - "fastvideo/v1/models/vaes/**"
                - "fastvideo/v1/models/loaders/**"
                - "fastvideo/v1/tests/vaes/**"
                - *common-paths
              config:
                command: "timeout 30m .buildkite/scripts/pr_test.sh"
                label: "VAE Tests"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=vae
                agents:
                  queue: "default"
            - path:
                - "fastvideo/v1/models/dits/**"
                - "fastvideo/v1/models/loaders/**"
                - "fastvideo/v1/tests/transformers/**"
                - "fastvideo/v1/layers/**"
                - "fastvideo/v1/attention/**"
                - *common-paths
              config:
                command: "timeout 30m .buildkite/scripts/pr_test.sh"
                label: "Transformer Tests"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=transformer
                agents:
                  queue: "default"
            - path: 
                - "fastvideo/v1/**/*.py"
              config:
                command: "timeout 60m .buildkite/scripts/pr_test.sh"
                label: "SSIM Tests"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=ssim
                agents:
                  queue: "default"
            - path:
                - "fastvideo/v1/**"
                - *common-paths
              config:
                command: "timeout 60m .buildkite/scripts/pr_test.sh"
                label: "Training Tests"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=training
                agents:
                  queue: "default"
            - path:
                - "fastvideo/v1/**"
                - *common-paths
                - *vsa-kernel-paths
              config:
                command: "timeout 60m .buildkite/scripts/pr_test.sh"
                label: "Training Tests VSA"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=training_vsa
                agents:
                  queue: "default"
            - path:
                - "fastvideo/v1/**"
                - *common-paths
                - *sta-kernel-paths
              config:
                command: "timeout 60m .buildkite/scripts/pr_test.sh"
                label: "Inference Tests STA"
                env:
                  - BUILDKITE_CLEAN_CHECKOUT=true
                  - TEST_TYPE=inference_sta
                agents:
                  queue: "default"
